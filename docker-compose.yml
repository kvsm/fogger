version: '2.0'
services:
  app:
    depends_on:
    - redis
    build: .
    volumes:
    - .:/app
    - ./var/:/fogger
    environment:
      # SOURCE_DATABASE_URL: postgresql://user1:pass@source:5432/bitpesa_api_development
      # TARGET_DATABASE_URL: postgresql://user1:pass@target:5432/bitpesa_api_development
      SOURCE_DATABASE_URL: postgresql://host.docker.internal:5432/bitpesa_api_development
      TARGET_DATABASE_URL: postgresql://host.docker.internal:5432/testing
      REDIS_URL: redis://redis
  worker:
    depends_on:
    - redis
    build: .
    volumes:
    - .:/app
    - ./var/:/fogger
    environment:
      # SOURCE_DATABASE_URL: postgresql://user1:pass@source:5432/bitpesa_api_development
      # TARGET_DATABASE_URL: postgresql://user1:pass@target:5432/bitpesa_api_development
      SOURCE_DATABASE_URL: postgresql://host.docker.internal:5432/bitpesa_api_development
      TARGET_DATABASE_URL: postgresql://host.docker.internal:5432/testing
      REDIS_URL: redis://redis
    restart: always
    command: fogger:consumer --messages=200
  redis:
    image: redis:4
  # source:
  #   volumes:
  #   - ./dump.sql:/docker-entrypoint-initdb.d/dump.sql
  #   environment:
  #     POSTGRES_DB: source
  #     # POSTGRES_DB: postgresql://host.docker.internal:5432/bitpesa_api_development
  #     POSTGRES_PASSWORD: pass
  #     POSTGRES_USER: user1
  #   image: postgres
  # target:
  #   environment:
  #     POSTGRES_DB: bitpesa_api_development
  #     POSTGRES_PASSWORD: pass
  #     POSTGRES_USER: user1
  #   image: postgres
